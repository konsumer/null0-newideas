<head>
  <title>null0</title>
  <style>
    /* this is not realy needed, but make it look nicer */
    body, html {
      margin:0;
      height: 90vh;
    }
    body {
      font-family: sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    #stdio {
      height: 50%;
      display: flex;
      gap: 10px;
    }
    textarea {
      flex-grow: 1;
      background: #000;
      color: #fff;
      padding: 10px;
      height: 100%;
    }
    textarea::-webkit-scrollbar {
      width: 1em;
    }

    textarea::-webkit-scrollbar-track {
      -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
    }

    textarea::-webkit-scrollbar-thumb {
      background-color: darkgrey;
      outline: 1px solid slategrey;
      cursor: grab;
    }
  </style>
</head>
<body>

<canvas id="null0"></canvas>
<div id="stdio">
  <textarea id="out"></textarea>
</div>
<script type="importmap">
  {
    "imports": {
      "easywasi": "https://esm.sh/easywasi",
      "@zenfs/core": "https://esm.sh/@zenfs/core",
      "@zenfs/dom": "https://esm.sh/@zenfs/dom",
      "@zenfs/zip": "https://esm.sh/@zenfs/zip"
    }
  }
</script>
<script type="module">
import { WasiPreview1 } from 'easywasi'
import { configure, InMemory, fs } from '@zenfs/core';
import { IndexedDB } from '@zenfs/dom';
import { Zip } from '@zenfs/zip';
import hostSetup from './host.mjs'

// TODO: figure out how to have isolated instances of fs, so it's not shared between multiple carts
await configure({
  mounts: {
    '/mnt/cart': {
      backend: Zip,
      data: await fetch('cartc.null0').then((r) => r.arrayBuffer())
    },
    '/mnt/as': {
      backend: Zip,
      data: await fetch('cartas.null0').then((r) => r.arrayBuffer())
    },
    '/mnt/tmp': InMemory,
    '/mnt/data': IndexedDB
  }
})

// make it more like an output-only terminal
document.getElementById('out').spellcheck = false
document.getElementById('out').disabled = true

async function setupCart(fs, mainLocation='/mnt/cart/main.wasm', args=['null0'], env={}) {
  const host = await hostSetup({cartfs: fs})
  const cartWasm = fs.readFileSync(mainLocation)
  const wasi_snapshot_preview1 = new WasiPreview1({ fs, args, env })
  const { instance } = await WebAssembly.instantiate(cartWasm, {
    wasi_snapshot_preview1
  })
  
  wasi_snapshot_preview1.setup(instance.exports)

  function addText(t, buffer) {
    t.value += wasi_snapshot_preview1.textDecoder.decode(buffer)
    t.selectionStart = t.selectionEnd = t.value.length
    t.blur()
    t.focus()
    t.blur()
  }
  wasi_snapshot_preview1.stdout = (buffer) => addText(document.getElementById('out'), buffer)
  // wasi_snapshot_preview1.stderr = (buffer) => addText(document.getElementById('err'), buffer)

  if (instance.exports._initialize) {
    instance.exports._initialize()
  }
  if (instance.exports._start) {
    instance.exports._start()
  }
  if (instance.exports.load) {
    instance.exports.load()
  }

  return { ...instance.exports, host }
}

const cartc = await setupCart(fs)
const cartas = await setupCart(fs,'/mnt/as/main.wasm' )

</script>
</body>